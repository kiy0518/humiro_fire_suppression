# QGC 개발 가이드 - 편대 제어 통신 프로토콜

**작성일**: 2026-01-02  
**대상**: QGC 프로그래머  
**목적**: 화재 진압 드론 편대 제어 시스템 연동

---

## 목차

1. [시스템 개요](#시스템-개요)
2. [통신 아키텍처](#통신-아키텍처)
3. [편대 제어 프로토콜](#편대-제어-프로토콜)
4. [MAVLink 메시지 정의](#mavlink-메시지-정의)
5. [ROS2 브릿지 (대안)](#ros2-브릿지-대안)
6. [QGC UI 요구사항](#qgc-ui-요구사항)
7. [개발 우선순위](#개발-우선순위)
8. [예제 코드](#예제-코드)

---

## 시스템 개요

### 화재 진압 드론 시스템 구성



### 하이브리드 편대 제어 방식

**리더 드론 (Drone 1)**:
- 화재 지점 분석
- 목표 할당 (자동)
- 편대원 상태 모니터링
- QGC와 직접 통신

**팔로워 드론 (Drone 2, 3, ...)**:
- 할당된 목표 독립 실행
- 자신의 상태 보고
- QGC와 직접 통신

**QGC (지상 관제소)**:
- 모든 드론 상태 모니터링
- 화재 지점 입력/수정
- 목표 할당 확인/변경
- 개별 격발 명령

---

## 통신 아키텍처

### Phase 1: 기본 통신 (현재)



**구현 완료**:
- 시동/이륙/착륙 명령
- 위치/자세 텔레메트리
- 배터리/GPS 상태
- RTSP 영상 스트리밍

---

### Phase 2: 편대 제어 통신 (신규 구현)

#### 옵션 1: MAVLink 커스텀 메시지 (권장)



**장점**:
- QGC 기본 MAVLink 프로토콜 활용
- 기존 인프라 재사용
- QGC 플러그인 개발 용이

**단점**:
- 커스텀 메시지 정의 필요
- MAVLink XML 수정

---

#### 옵션 2: ROS2 직접 브릿지 (대안)



**장점**:
- 유연한 메시지 포맷
- ROS2 네이티브 통신

**단점**:
- QGC에서 별도 브릿지 구현 필요
- 기존 MAVLink 인프라 미활용

---

### 권장: MAVLink 커스텀 메시지 방식

**이유**:
1. QGC는 MAVLink 네이티브 지원
2. VIM4에는 MAVLink Router 이미 구현됨
3. 최소한의 코드 변경으로 구현 가능

---

## 편대 제어 프로토콜

### 통신 흐름

#### 1. 편대 상태 보고 (드론 → QGC)

**빈도**: 1Hz (1초마다)  
**방향**: 모든 드론 → QGC

**데이터**:
- 드론 ID
- 현재 위치 (GPS)
- 배터리 잔량
- 소화탄 잔량 (0-6)
- 미션 상태
- 할당된 목표 ID

---

#### 2. 목표 할당 (QGC → 드론)

**빈도**: 이벤트 기반  
**방향**: QGC → 개별 드론

**데이터**:
- 드론 ID
- 목표 ID
- 목표 위치 (GPS)
- 우선순위

---

#### 3. 격발 명령 (QGC → 드론)

**빈도**: 이벤트 기반  
**방향**: QGC → 개별 드론

**데이터**:
- 드론 ID
- 격발 활성화 (true/false)

---

#### 4. 진행 상황 보고 (드론 → QGC)

**빈도**: 상태 변경 시  
**방향**: 개별 드론 → QGC

**데이터**:
- 드론 ID
- 목표 ID
- 진행 상태 (ASSIGNED, IN_PROGRESS, COMPLETED, FAILED)
- 사용한 소화탄 수

---

## MAVLink 메시지 정의

### 1. FORMATION_MEMBER_STATUS (드론 → QGC)

**Message ID**: 12920 (임시, MAVLink 공식 할당 필요)



**Mission State Enum**:


---

### 2. TARGET_ASSIGNMENT (QGC → 드론)

**Message ID**: 12921 (임시)



---

### 3. FIRE_COMMAND (QGC → 드론)

**Message ID**: 12922 (임시)



---

### 4. MISSION_PROGRESS (드론 → QGC)

**Message ID**: 12923 (임시)



**Progress Status Enum**:


---

## ROS2 브릿지 (대안)

MAVLink 커스텀 메시지 대신 ROS2 직접 통신을 원할 경우:

### VIM4 ROS2 토픽 (이미 정의됨)

#### 드론 → QGC

| 토픽 | 메시지 타입 | 용도 |
|------|------------|------|
|  |  | 편대원 상태 |
|  |  | 진행 상황 |
|  |  | OFFBOARD 모드 상태 |

#### QGC → 드론

| 토픽 | 메시지 타입 | 용도 |
|------|------------|------|
|  |  | 목표 할당 |
|  |  | 격발 명령 |

### QGC ROS2 브릿지 구현

**Python 예제**:


---

## QGC UI 요구사항

### 1. 편대 상태 모니터링 패널

**표시 정보** (드론별):


**색상 코딩**:
- ✓ 녹색: 정상
- ⚠ 노란색: 경고 (배터리 < 30%)
- ✗ 빨간색: 에러/실패

---

### 2. 화재 지점 관리 패널

**기능**:
- 화재 지점 추가/삭제
- 지도에 표시
- 우선순위 설정



---

### 3. 목표 할당 패널

**기능**:
- 자동 할당 (리더 알고리즘)
- 수동 할당 (GCS 지정)
- 할당 변경



---

### 4. 격발 제어 패널

**기능**:
- 개별 드론 격발 명령
- 전체 격발
- 격발 중지



---

### 5. 지도 뷰

**표시 요소**:
- 드론 위치 (아이콘 + ID)
- 화재 지점 (불 아이콘)
- 할당 라인 (드론 → 목표)
- 드론 경로 (이동 궤적)



---

## 개발 우선순위

### Phase 1: 기본 통신 (1주)

**VIM4 측**:
- [x] ROS2 토픽 정의 (완료)
- [ ] MAVLink 브릿지 구현
  - FORMATION_MEMBER_STATUS 발행
  - TARGET_ASSIGNMENT 수신
  - FIRE_COMMAND 수신

**QGC 측**:
- [ ] MAVLink 커스텀 메시지 정의 (XML)
- [ ] FORMATION_MEMBER_STATUS 수신 처리
- [ ] 기본 상태 모니터링 UI

---

### Phase 2: UI 구현 (1주)

**QGC 측**:
- [ ] 편대 상태 모니터링 패널
- [ ] 화재 지점 관리 패널
- [ ] 지도 뷰 (드론 + 목표)

---

### Phase 3: 제어 기능 (1주)

**QGC 측**:
- [ ] 목표 할당 패널
- [ ] TARGET_ASSIGNMENT 발행
- [ ] FIRE_COMMAND 발행
- [ ] 격발 제어 패널

---

### Phase 4: 통합 테스트 (1주)

**통합**:
- [ ] VIM4 ↔ QGC 연동 테스트
- [ ] 2대 편대 시나리오
- [ ] 3대 편대 시나리오
- [ ] 장애 시나리오

---

## 예제 코드

### VIM4: MAVLink 브릿지

**파일**: 

# 0 "<stdin>"
# 0 "<built-in>"
# 0 "<command-line>"
# 1 "/usr/include/stdc-predef.h" 1 3 4
# 0 "<command-line>" 2
# 1 "<stdin>"

---

### QGC: 상태 수신

**파일**: 

# 0 "<stdin>"
# 0 "<built-in>"
# 0 "<command-line>"
# 1 "/usr/include/stdc-predef.h" 1 3 4
# 0 "<command-line>" 2
# 1 "<stdin>"

---

### QGC: 목표 할당 발행

**파일**: 

# 0 "<stdin>"
# 0 "<built-in>"
# 0 "<command-line>"
# 1 "/usr/include/stdc-predef.h" 1 3 4
# 0 "<command-line>" 2
# 1 "<stdin>"

---

### QGC: 격발 명령

**파일**: 

# 0 "<stdin>"
# 0 "<built-in>"
# 0 "<command-line>"
# 1 "/usr/include/stdc-predef.h" 1 3 4
# 0 "<command-line>" 2
# 1 "<stdin>"

---

## MAVLink XML 정의

**파일**: 



---

## 참고 자료

### VIM4 측 문서
- : 편대 제어 구현 계획
- : ROS2 토픽 구조
- : 자율 제어 시스템

### 관련 코드
- : 자율 비행 핸들러 (Phase 1 완료)
- : MAVLink Router 설정

---

## 연락 및 협업

**VIM4 개발팀**:
- 편대 통신 모듈: 
- MAVLink 브릿지:  (예정)

**프로토콜 조율**:
- MAVLink 메시지 ID 할당
- 메시지 포맷 확정
- 테스트 시나리오 합의

---

**작성자**: Claude Code Assistant  
**버전**: v1.0  
**작성일**: 2026-01-02  
**다음 업데이트**: VIM4 MAVLink 브릿지 구현 후
