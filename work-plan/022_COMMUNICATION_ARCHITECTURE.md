# 통신 아키텍처 구성도

## 1. 전체 시스템 구성

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              WiFi 네트워크 (192.168.100.x)                            │
└─────────────────────────────────────────────────────────────────────────────────────┘
         │                                    │                              │
         │ UDP                                │ UDP                          │ UDP
         │ 14550 (수신)                       │ 14553 (송신)                  │ 14550 (수신)
         │                                    │                              │
         ▼                                    ▼                              ▼
┌─────────────────┐                 ┌─────────────────┐              ┌─────────────────┐
│      QGC        │                 │  SENDER GUI     │              │   기타 QGC      │
│  (Ground        │                 │  (custom_       │              │   클라이언트    │
│   Control)      │                 │   message_      │              │                 │
│                 │                 │   sender_gui)   │              │                 │
│ - FC 상태 모니터│                 │                 │              │                 │
│ - 수동 제어     │                 │ - 커스텀 메시지 │              │                 │
│ - 미션 관리     │                 │ - 표준 메시지   │              │                 │
│                 │                 │ - 디버깅용      │              │                 │
└─────────────────┘                 └─────────────────┘              └─────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                     VIM4 (SBC)                                       │
│                                   192.168.100.31 (WiFi)                              │
│                                   10.0.0.31 (Ethernet)                               │
│  ┌────────────────────────────────────────────────────────────────────────────────┐ │
│  │                            MAVLink Router                                       │ │
│  │                                                                                 │ │
│  │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    │ │
│  │   │     FC      │    │     GCS     │    │  External   │    │  LocalApp   │    │ │
│  │   │  Endpoint   │    │  Endpoint   │    │  Endpoint   │    │  Endpoint   │    │ │
│  │   ├─────────────┤    ├─────────────┤    ├─────────────┤    ├─────────────┤    │ │
│  │   │ Mode:Server │    │Mode:Normal  │    │ Mode:Server │    │ Mode:Normal │    │ │
│  │   │ Port: 14540 │    │Addr:브로드캐│    │ Port: 14553 │    │Addr:127.0.0.1│   │ │
│  │   │ Addr:0.0.0.0│    │     스트    │    │ Addr:0.0.0.0│    │ Port: 14551 │    │ │
│  │   │             │    │Port: 14550  │    │             │    │             │    │ │
│  │   │ [수신 대기] │    │ [송신 전용] │    │ [수신 대기] │    │ [송신]      │    │ │
│  │   └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    │ │
│  │          │                  │                  │                  │           │ │
│  │          │                  │                  │                  │           │ │
│  │          └──────────────────┴──────────────────┴──────────────────┘           │ │
│  │                                    │                                           │ │
│  │                            [메시지 라우팅]                                     │ │
│  │                                    │                                           │ │
│  └────────────────────────────────────┼───────────────────────────────────────────┘ │
│                                       │                                             │
│                                       ▼                                             │
│  ┌────────────────────────────────────────────────────────────────────────────────┐ │
│  │                         메인 프로그램 (humiro_fire_sup)                         │ │
│  │                                                                                 │ │
│  │   - 커스텀 메시지 처리 (50000번대)                                              │ │
│  │   - 표준 메시지는 그대로 FC로 전달                                              │ │
│  │   - 커스텀 메시지 → 표준 메시지 시퀀스 변환                                     │ │
│  │     예: FIRE_MISSION_START → ARM → TAKEOFF → MOVE                              │ │
│  │                                                                                 │ │
│  │   수신 포트: 14551 (LocalApp에서 전달받음)                                      │ │
│  │   송신 포트: 14550 (브로드캐스트로 응답)                                        │ │
│  └────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                      │
│  ┌────────────────────────────────────────────────────────────────────────────────┐ │
│  │                         DDS Agent (micro-ros-agent)                             │ │
│  │                                                                                 │ │
│  │   - ROS2 토픽 통신용 (MAVLink와 별개)                                           │ │
│  │   - FC의 uXRCE-DDS 클라이언트와 연결                                            │ │
│  │   - 포트: 8888                                                                  │ │
│  └────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────┘
         │                                                              │
         │ UDP 14540 (MAVLink)                                          │ UDP 8888 (DDS)
         │                                                              │
         ▼                                                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                     FC (PX4)                                         │
│                                     10.0.0.32                                        │
│                                                                                      │
│   ┌─────────────────────────────┐          ┌─────────────────────────────┐          │
│   │      MAVLink 모듈           │          │      uXRCE-DDS 클라이언트   │          │
│   │      (MAV_2)                │          │                             │          │
│   │                             │          │                             │          │
│   │  - UDP_PRT: 14550 (송신)    │          │  - AG_IP: 10.0.0.31        │          │
│   │  - REMOTE_PRT: 14540        │          │  - Port: 8888              │          │
│   │  - BROADCAST: 1             │          │                             │          │
│   │  - MODE: NORMAL             │          │                             │          │
│   └─────────────────────────────┘          └─────────────────────────────┘          │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 데이터 흐름

### 2.1 FC → QGC (상태 모니터링)

```
FC (10.0.0.32)
    │
    │ MAVLink (UDP)
    │ 브로드캐스트 → 10.0.0.31:14540
    ▼
VIM4 MAVLink Router
    │
    │ FC Endpoint (Server, 14540) 에서 수신
    │
    │ 내부 라우팅
    │
    │ GCS Endpoint (Normal) 로 전달
    ▼
브로드캐스트 192.168.100.255:14550
    │
    │ WiFi 네트워크로 전파
    ▼
QGC (192.168.100.x:14550)
    │
    └─► FC 상태 표시
```

### 2.2 SENDER GUI → FC (명령 전송)

```
SENDER GUI (192.168.100.x)
    │
    │ UDP 송신
    │ 목적지: 192.168.100.31:14553  ◄── 새로운 External 포트!
    ▼
VIM4 MAVLink Router
    │
    │ External Endpoint (Server, 14553) 에서 수신
    │
    │ 내부 라우팅 (메시지 종류에 따라)
    │
    ├──────────────────────────────────┐
    │                                  │
    ▼ (표준 메시지)                    ▼ (모든 메시지 복사)
FC Endpoint                      LocalApp Endpoint
    │                                  │
    │ UDP 14540                        │ UDP 14551
    ▼                                  ▼
FC (10.0.0.32)                   메인 프로그램
                                      │
                                      │ (커스텀 메시지 처리)
                                      │ FIRE_MISSION_START 등
                                      ▼
                                 표준 메시지 시퀀스 생성
                                 ARM → TAKEOFF → MOVE
                                      │
                                      │ UDP 14550
                                      ▼
                                 MAVLink Router → FC
```

---

## 3. 포트 정리

| 포트 | 방향 | 모드 | 용도 |
|------|------|------|------|
| **14540** | FC → VIM4 | Server (수신) | FC MAVLink 메시지 수신 |
| **14550** | VIM4 → QGC | Normal (송신) | FC 상태 브로드캐스트 |
| **14553** | GUI → VIM4 | Server (수신) | 외부 명령 수신 (새로 추가) |
| **14551** | VIM4 내부 | Normal (송신) | 메인 프로그램으로 전달 |
| **8888** | FC ↔ VIM4 | UDP | DDS Agent (ROS2 토픽) |

---

## 4. SENDER GUI 설정

### 변경 전
```
대상 IP: 192.168.100.31
포트: 14550  ← 수신할 곳 없음 (Normal 모드는 송신만)
```

### 변경 후
```
대상 IP: 192.168.100.31
포트: 14553  ← External Endpoint에서 수신
```

---

## 5. 요약

```
┌─────────────────────────────────────────────────────────────────┐
│                        포트 사용 요약                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  [FC 방향]                                                       │
│  14540: FC → VIM4 (Server, 수신)                                │
│                                                                  │
│  [QGC 방향]                                                      │
│  14550: VIM4 → QGC (Normal, 브로드캐스트 송신)                  │
│                                                                  │
│  [외부 명령 입력]                                                │
│  14553: GUI/SENDER → VIM4 (Server, 수신) ◄── 새로 추가!         │
│                                                                  │
│  [내부 처리]                                                     │
│  14551: Router → 메인프로그램 (Normal, 송신)                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. QGC 양방향 통신 (커스텀 메시지 포함)

### 6.1 FC 포트 설정

```
FC (PX4) MAVLink 설정:
┌─────────────────────────────────────────────────────────────────┐
│  MAV_2_UDP_PRT: 14550     ← FC의 로컬 포트 (송신 소스)          │
│  MAV_2_REMOTE_PRT: 14540  ← FC가 보내는 목적지 포트 (VIM4)      │
│  MAV_2_BROADCAST: 1       ← 브로드캐스트 모드                   │
│  MAV_2_MODE: NORMAL       ← 일반 모드                          │
└─────────────────────────────────────────────────────────────────┘

FC 동작:
- 송신: 10.0.0.32:14550 → 10.0.0.255:14540 (브로드캐스트)
- 수신: 10.0.0.32:14550 에서 들어오는 패킷 수신
```

### 6.2 QGC → VIM4 → FC 통신 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                    QGC 양방향 통신 흐름                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. VIM4 Router가 FC 상태를 브로드캐스트                        │
│     ┌─────────────────────────────────────────────────────────┐ │
│     │ 소스: 192.168.100.31:(임의 포트 X)                      │ │
│     │ 목적지: 192.168.100.255:14550 (브로드캐스트)            │ │
│     └─────────────────────────────────────────────────────────┘ │
│                           │                                      │
│                           ▼                                      │
│  2. QGC가 14550에서 수신                                        │
│     ┌─────────────────────────────────────────────────────────┐ │
│     │ QGC는 패킷의 소스 주소를 기억: 192.168.100.31:X         │ │
│     └─────────────────────────────────────────────────────────┘ │
│                           │                                      │
│                           ▼                                      │
│  3. QGC가 명령 전송 시 (표준/커스텀 메시지 모두)                │
│     ┌─────────────────────────────────────────────────────────┐ │
│     │ 목적지: 192.168.100.31:X (기억한 소스 주소로 응답)      │ │
│     │ → 이것이 UDP 양방향 통신의 핵심!                        │ │
│     └─────────────────────────────────────────────────────────┘ │
│                           │                                      │
│                           ▼                                      │
│  4. VIM4 Router가 GCS 엔드포인트에서 수신                       │
│     ┌─────────────────────────────────────────────────────────┐ │
│     │ Normal 모드 소켓은 송신뿐 아니라 수신도 가능 (UDP 특성) │ │
│     │ → 받은 메시지를 모든 엔드포인트로 라우팅                │ │
│     └─────────────────────────────────────────────────────────┘ │
│                           │                                      │
│              ┌────────────┴────────────┐                        │
│              ▼                         ▼                        │
│  5a. FC Endpoint로 전달         5b. LocalApp으로 전달           │
│      │                               │                          │
│      ▼                               ▼                          │
│  FC (10.0.0.32:14550)          메인 프로그램 (14551)            │
│  표준 메시지 처리               커스텀 메시지 처리              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.3 GCS Normal 모드의 양방향 특성

```
┌─────────────────────────────────────────────────────────────────┐
│                  GCS Endpoint (Normal 모드)                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  [소켓 생성 시]                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ Router가 UDP 소켓 생성                                      ││
│  │ - 로컬 포트: 임의 (예: 45678)                               ││
│  │ - 목적지: 192.168.100.255:14550                             ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  [송신 - FC 상태 브로드캐스트]                                  │
│  192.168.100.31:45678 → 192.168.100.255:14550                   │
│                                                                  │
│  [수신 - QGC 응답]                                              │
│  QGC가 192.168.100.31:45678 로 응답 → 같은 소켓에서 수신       │
│                                                                  │
│  ※ UDP 소켓은 양방향! 송신용 소켓으로도 수신 가능              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.4 최종 구조도

```
┌──────────┐                    ┌─────────────────────────────────┐                    ┌──────────┐
│   QGC    │◄──브로드캐스트────│         VIM4 Router             │◄───14540──────────│    FC    │
│          │   14550           │                                  │   (FC 상태)       │          │
│          │                    │  FC: Server 14540 (수신)        │                    │          │
│          │───응답────────────►│  GCS: Normal 14550 (양방향)     │────FC소켓─────────►│          │
│          │  (소스포트로)      │  External: Server 14553 (수신)  │  (10.0.0.32:14550)│          │
└──────────┘                    │  LocalApp: Normal 14551 (전달)  │                    └──────────┘
                                └─────────────────────────────────┘
                                         ▲
┌──────────┐                             │
│  SENDER  │─────────14553───────────────┘
│   GUI    │  (직접 연결용)
└──────────┘
```

---

## 7. 결론

| 클라이언트 | 전송 포트 | 통신 방식 |
|------------|-----------|-----------|
| **QGC** | 소스포트로 응답 | GCS Normal 모드의 양방향 UDP 활용 |
| **SENDER GUI** | 14553 | External Server 모드로 직접 수신 |

- **QGC**: 별도 설정 없이 기존 방식대로 동작 (브로드캐스트 수신 → 소스로 응답)
- **SENDER GUI**: 14553 포트로 전송하도록 설정 변경 필요
