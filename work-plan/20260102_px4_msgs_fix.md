# PX4 메시지 버전 불일치 해결

**날짜**: 2026-01-02  
**작업자**: Claude + Humiro  
**중요도**: ⭐⭐⭐ (시스템 핵심 기능)

## 문제 상황

ROS2를 통해 FC(Flight Controller)로부터 토픽을 받아 영상 OSD에 표시하는 기능 개발 중:

- ✅ **비행 모드**: 정상 작동
- ✅ **상태 정보**: 정상 작동
- ❌ **배터리 정보**: 수신 실패
- ❌ **GPS 정보**: 수신 실패

### 에러 메시지

```
[RTPS_READER_HISTORY Error] Change payload size of '184' bytes is larger 
than the history payload size of '183' bytes and cannot be resized.
```

- 반복적으로 발생하는 payload 크기 불일치 에러
- PX4가 보내는 메시지(184 bytes) vs 구독자 예상(183 bytes) = **1바이트 차이**

## 원인 분석

### 1. px4_msgs 버전 불일치
- **사용 중이던 버전**: main 브랜치 (최신 개발 버전)
  - Commit: 87784a4 - Update to PX4 e6c49edd20c98feb0a6342fb322aa839c5c45a9c
- **필요한 버전**: release/1.16 브랜치
  - PX4 펌웨어 v1.16과 호환되는 메시지 정의

### 2. FastRTPS 설정
- 초기에는 FastRTPS 프로파일 설정도 의심했으나, 근본 원인은 메시지 정의 버전이었음
- `DYNAMIC`, `DYNAMIC_RESERVE`, `PREALLOCATED_WITH_REALLOC` 등 시도했으나 효과 없음

### 3. QoS 설정
- QoS는 올바르게 설정되어 있었음:
  - Reliability: BEST_EFFORT
  - Durability: TRANSIENT_LOCAL
  - History: KEEP_LAST (depth: 100)

## 해결 방법

### 1. px4_msgs 버전 변경

```bash
cd ~/humiro_fire_suppression/workspaces/px4_ros2_ws/src/px4_msgs
git checkout release/1.16
```

현재 커밋: 392e831 - Update message definitions Thu Aug 7 19:15:05 UTC 2025

### 2. px4_msgs 클린 빌드

```bash
cd ~/humiro_fire_suppression/workspaces/px4_ros2_ws
rm -rf build install log
source /opt/ros/humble/setup.bash
colcon build --packages-select px4_msgs
```

### 3. 애플리케이션 재빌드

```bash
cd ~/humiro_fire_suppression/application
./build.sh --build-only
```

### 4. FastRTPS 환경 변수 설정

`~/.bashrc`에 추가:
```bash
export FASTRTPS_DEFAULT_PROFILES_FILE=/home/humiro/humiro_fire_suppression/config/fastrtps_profile.xml
```

## 검증 결과

### 배터리 토픽 (/fmu/out/battery_status)

```yaml
timestamp: 1767318942916891
connected: true
voltage_v: 14.69V
current_a: 0.18A
remaining: 0.165 (16.5%)
temperature: 37.1°C
cell_count: 4
satellites_used: 6
warning: 0
```

✅ **정상 수신 확인**

### GPS 토픽 (/fmu/out/vehicle_gps_position)

```yaml
timestamp: 1767318955838941
latitude_deg: 35.906°N
longitude_deg: 128.797°E
altitude_msl_m: 176.8m
altitude_ellipsoid_m: 200.1m
fix_type: 3 (3D Fix)
satellites_used: 6
hdop: 2.05
vel_m_s: 1.27 m/s
```

✅ **정상 수신 확인**

### 비행 모드 토픽 (/fmu/out/vehicle_status_v1)

```yaml
nav_state: 1 → Altitude
arming_state: true (시동 ON)
```

✅ **이미 정상 작동 중**

## 수정된 파일

### 1. px4_msgs 저장소
- **위치**: `~/humiro_fire_suppression/workspaces/px4_ros2_ws/src/px4_msgs`
- **변경**: main → release/1.16 브랜치

### 2. 환경 설정
- **파일**: `~/.bashrc`
- **추가**: `export FASTRTPS_DEFAULT_PROFILES_FILE=/home/humiro/humiro_fire_suppression/config/fastrtps_profile.xml`

### 3. FastRTPS 프로파일
- **파일**: `~/humiro_fire_suppression/config/fastrtps_profile.xml`
- **변경**: historyMemoryPolicy를 PREALLOCATED_WITH_REALLOC로 설정

## 코드 분석

### status_ros2_subscriber.cpp

주요 구독자 설정:

```cpp
// PX4 uXRCE-DDS QoS 설정
rclcpp::QoS px4_qos(100);
px4_qos.reliability(rclcpp::ReliabilityPolicy::BestEffort);
px4_qos.durability(rclcpp::DurabilityPolicy::TransientLocal);
px4_qos.history(rclcpp::HistoryPolicy::KeepLast);

// 배터리 상태 구독
battery_sub_ = node_->create_subscription<px4_msgs::msg::BatteryStatus>(
    /fmu/out/battery_status, px4_qos,
    std::bind(&StatusROS2Subscriber::batteryCallback, this, std::placeholders::_1));

// GPS 상태 구독 (실제 메시지 타입은 SensorGps)
gps_sub_ = node_->create_subscription<px4_msgs::msg::SensorGps>(
    /fmu/out/vehicle_gps_position, px4_qos,
    std::bind(&StatusROS2Subscriber::gpsCallback, this, std::placeholders::_1));
```

- QoS 설정은 올바랐음
- 문제는 메시지 타입 정의 버전

## 교훈 및 참고사항

### 1. PX4 메시지 버전 관리 중요성
- PX4 펌웨어 버전과 px4_msgs 버전이 정확히 일치해야 함
- main 브랜치는 개발용이므로 안정적인 release 브랜치 사용 필요

### 2. 버전 확인 방법

```bash
# PX4 펌웨어 버전 확인 (QGroundControl에서)
# px4_msgs 브랜치 확인
cd ~/humiro_fire_suppression/workspaces/px4_ros2_ws/src/px4_msgs
git branch -a
git log -1 --oneline

# 메시지 타입 확인
ros2 interface show px4_msgs/msg/BatteryStatus
```

### 3. 디버깅 팁
- payload 크기 에러는 거의 항상 메시지 정의 버전 불일치
- QoS나 FastRTPS 설정보다 먼저 버전 확인
- `ros2 topic info -v` 로 publisher/subscriber 상태 확인

## 향후 작업

- [ ] 다른 PX4 토픽들도 테스트 (attitude, local_position 등)
- [ ] OSD 디스플레이에서 배터리/GPS 정보 표시 확인
- [ ] px4_msgs 버전을 문서화하여 재발 방지
- [ ] CI/CD에 px4_msgs 버전 체크 추가 고려

## 관련 파일

- `~/humiro_fire_suppression/ros2/src/status/status_ros2_subscriber.cpp`
- `~/humiro_fire_suppression/ros2/src/status/status_ros2_subscriber.h`
- `~/humiro_fire_suppression/config/fastrtps_profile.xml`
- `~/humiro_fire_suppression/workspaces/px4_ros2_ws/src/px4_msgs/`

## 참고 문서

- [PX4 uXRCE-DDS Documentation](https://docs.px4.io/main/en/middleware/uxrce_dds.html)
- [px4_msgs GitHub](https://github.com/PX4/px4_msgs)
- [ROS2 QoS Documentation](https://docs.ros.org/en/humble/Concepts/About-Quality-of-Service-Settings.html)

---

**태그**: `fix/px4-msgs-version-v1.16`  
**Git Commit**: (다음 커밋에 포함)
