# OFFBOARD 모드 활성화 가이드

## 개요

OFFBOARD 모드는 VIM4의 자동 제어 시스템에서 사용하는 필수 모드입니다. 이 모드를 활성화하려면 QGroundControl(QGC)에서 설정해야 합니다.

---

## 활성화 방법

### 1. QGC에서 Flight Modes 설정

1. **QGC 실행 및 드론 연결**
   - QGC를 실행하고 드론과 연결합니다.

2. **설정 메뉴로 이동**
   - 상단 메뉴에서 **설정(Setup)** 탭을 선택합니다.
   - 왼쪽 메뉴에서 **비행 모드(Flight Modes)** 섹션을 선택합니다.

3. **OFFBOARD 모드 할당**
   - 사용하지 않는 **스위치 위치** 중 하나를 선택합니다.
   - 드롭다운 메뉴에서 **오프보드(Offboard)** 모드를 선택합니다.
   - 예: "Switch 6" 또는 "Switch 7"에 "Offboard" 할당

4. **저장**
   - 설정을 저장하면 RC 스위치로 OFFBOARD 모드로 전환할 수 있습니다.

---

## 파라미터 확인 (선택사항)

OFFBOARD 모드가 제대로 작동하려면 다음 파라미터를 확인할 수 있습니다:

### 주요 파라미터

1. **`COM_OF_LOSS_T`** (오프보드 신호 손실 타임아웃)
   - 기본값: 0.5초
   - 의미: 오프보드 명령이 이 시간 동안 없으면 페일세이프 동작
   - 권장값: 0.5 ~ 1.0초 (VIM4가 주기적으로 명령을 보내므로)

2. **`COM_RC_IN_MODE`** (RC 입력 모드)
   - 기본값: 0 (자동)
   - 의미: RC 입력 처리 방식
   - 일반적으로 변경 불필요

3. **`NAV_DLL_ACT`** (데이터 링크 손실 동작)
   - 기본값: 0 (비활성화)
   - 의미: 데이터 링크 손실 시 동작
   - 권장값: 0 (비활성화) 또는 1 (RTL)

4. **`NAV_RCL_ACT`** (RC 링크 손실 동작)
   - 기본값: 0 (비활성화)
   - 의미: RC 링크 손실 시 동작
   - 권장값: 0 (비활성화) 또는 1 (RTL)

---

## 확인 방법

### 1. QGC에서 확인
- Flight Modes 설정에서 OFFBOARD 모드가 할당되었는지 확인
- RC 스위치를 해당 위치로 이동했을 때 QGC 상단에 "OFFBOARD" 모드가 표시되는지 확인

### 2. ROS2 토픽에서 확인
```bash
# PX4 상태 확인
ros2 topic echo /fmu/out/vehicle_status_v1 --once | grep nav_state

# nav_state가 9이면 OFFBOARD 모드
# nav_state: 9 = OFFBOARD
```

### 3. 프로그램 로그에서 확인
- 프로그램 실행 시 `[비행 모드 변경] ... → OFFBOARD` 메시지 확인
- 상태바에 "OFFBOARD" 모드 표시 확인

---

## 주의사항

1. **주기적 명령 필요**
   - OFFBOARD 모드에서는 VIM4가 주기적으로 제어 명령을 보내야 합니다.
   - 명령이 중단되면 `COM_OF_LOSS_T` 시간 후 페일세이프 동작이 발생합니다.

2. **안전성**
   - OFFBOARD 모드 전환 전에 VIM4 자동 제어 시스템이 실행 중인지 확인하세요.
   - 테스트 시 낮은 고도에서 시작하세요.

3. **RC 스위치**
   - OFFBOARD 모드로 전환하려면 RC 스위치를 해당 위치로 이동해야 합니다.
   - QGC에서만 모드를 변경하는 것은 불가능합니다 (안전상 이유).

---

## 문제 해결

### OFFBOARD 모드가 나타나지 않는 경우

1. **QGC 버전 확인**
   - 최신 버전의 QGC를 사용하고 있는지 확인
   - PX4 펌웨어 버전과 호환되는 QGC 버전 사용

2. **PX4 펌웨어 확인**
   - PX4 펌웨어가 OFFBOARD 모드를 지원하는지 확인
   - 일반적으로 모든 PX4 펌웨어에서 지원

3. **파라미터 확인**
   - `COM_OF_LOSS_T` 파라미터가 설정되어 있는지 확인
   - 값이 0이면 OFFBOARD 모드가 비활성화될 수 있음

### OFFBOARD 모드로 전환되지 않는 경우

1. **RC 스위치 확인**
   - RC 스위치가 올바른 위치에 있는지 확인
   - RC 연결 상태 확인

2. **VIM4 연결 확인**
   - VIM4가 PX4와 연결되어 있는지 확인
   - ROS2 토픽이 수신되는지 확인

3. **안전 스위치 확인**
   - 안전 스위치가 활성화되어 있는지 확인
   - 일부 설정에서는 안전 스위치가 필요할 수 있음

---

## 참고 자료

- [PX4 공식 문서: Offboard 모드](https://docs.px4.io/v1.14/en/flight_modes/offboard.html)
- [PX4 공식 문서: Flight Modes](https://docs.px4.io/v1.14/en/getting_started/flight_modes.html)

